<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/styles/dashboard.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }

    h1 {
      text-align: center;
    }

    label {
      font-size: 16px;
      display: inline-block;
      margin-top: 15px;
    }

    #toggle-active-only {
      margin-right: 8px;
    }

    .token-table-wrapper {
      height: 60vh;
      overflow-y: auto;
      border: 1px solid #ccc;
      margin-top: 20px;
      border-radius: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    th {
      background-color: #3498db;
      color: white;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      background-color: #2ecc71;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-danger {
      background-color: #e74c3c;
    }

    .status-active {
      color: green;
      font-weight: bold;
    }

    .status-completed {
      color: gray;
    }
    tr.status-complete{
      background-color: #a0e5c5;
    }
    tr.status-cancelled{
      background-color: rgb(180, 176, 176);
    }

    .status-cancelled {
      color: red;
      text-decoration: line-through;
    }

    .current-token {
      background-color: #7eeef6;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>Welcome, <%= user.name %> (Admin)</h1>

  <% if (locals.store) { %>
    <% const store=locals.store %>
      <section>
        <h2>Store Details</h2>
        <p><strong>Name:</strong>
          <%= store.name %>
        </p>
        <p><strong>Address:</strong>
          <%= store.address %>
        </p>
        <p><strong>Contact:</strong>
          <%= store.contact %>
        </p>
      </section>

      <!-- <section>
      <h2>Manage Out-of-Stock Medicines</h2>
      <form action="/admin/update-outofstock" method="POST">
        <textarea name="outOfStockList" rows="5" placeholder="Enter medicine names, comma-separated"><%= store.outOfStock?.join(", ") || "" %></textarea>
        <button type="submit">Update</button>
      </form>
    </section> -->

      <section>
        <h1>Admin Token Queue Management</h1>

        <% if (locals.tokens.length> 0) { %>
          <% const tokens=locals.tokens %>
            <label>
              <input type="checkbox" id="toggle-active-only"   />
              Show only active tokens
            </label>
            <div class="token-table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Token #</th>
                    <th>User</th>
                    <th>Status</th>
                    <th>Position</th>
                    <th>Estimated Wait</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="token-table-body">
                  <% let activeIndex=0; %>
                    <% tokens.forEach((token, index)=> { %>
                      <% const isCurrent=token.status==='active' && activeIndex===0; %>
                        <tr id="row-<%= token._id %>"
                          class="token-row status-<%= token.status %> <%= isCurrent ? 'current-token' : '' %>">
                          <td>
                            <%= token.tokenNumber %>
                          </td>
                          <td>
                            <%= token.user ? token.user.name : 'Unknown' %>
                          </td>
                          <td class="status status-<%= token.status %>">
                            <%= token.status %>
                          </td>
                          <td>
                            <%= token.status==='active' ? ++activeIndex : '-' %>
                          </td>
                          <td>
                            <%= token.status==='active' ? ((activeIndex - 1) * 3) : '-' %> min
                          </td>
                          <td>
                            <% if (token.status==='active' ) { %>
                              <form method="POST" action="/admin/update-token/<%= token._id %>">
                                <input type="hidden" name="action" value="complete" />
                                <button class="btn" type="submit" onclick="this.form.action.value='complete'">Mark
                                  Completed</button>
                                <button class="btn btn-danger" type="submit"
                                  onclick="this.form.action.value='cancelled'">Cancel Token</button>
                              </form>
                              <% } else { %>
                                <button class="btn btn-danger" disabled>
                                  <%= token.status%>
                                </button>
                                <% } %>
                          </td>
                        </tr>
                        <% }); %>
                </tbody>
              </table>
            </div>
            <% } else { %>
              <p>No tokens generated yet.</p>
              <% } %>
      </section>
      <% } else { %>
        <section>
          <h2>Add Your Store</h2>
          <form action="/admin/add-store" method="POST">
            <input name="name" placeholder="Store Name" required>
            <input name="address" placeholder="Address">
            <input name="contact" placeholder="Contact Info">
            <button type="submit">Add Store</button>
          </form>
        </section>
        <% } %>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const storeId = "<%= locals.store._id %>";
  socket.emit("join-store", storeId);


  // whene user generates token or cancel its token
  socket.on("storeQueueUpdate", (data) => {
    if (data.storeId == storeId) {
      alert("tokenStatusChanged worked");
      location.reload();
    }
  })

  // socket.on("tokenStatusChanged" , (data)=>{
  //   if(data.storeId==storeId){
  //     console.log("tokenStatusChanged worked");
  //     location.reload();
  //   }
  // })
  const toggleCheckBox=document.getElementById("toggle-active-only");
  const filterRows = () => {
    const rows = document.querySelectorAll(".token-row");
    rows.forEach(row => {
      const isActive = row.classList.contains("status-active");
      row.style.display = toggleCheckBox.checked ? (isActive ? "" : "none") : "";
    });
    
  };
  toggleCheckBox.addEventListener("change" , filterRows);
  window.addEventListener("DOMContentLoaded", () => {
    const currentRow = document.querySelector(".current-token");
    if (currentRow) {
      currentRow.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  });
  filterRows();
  
</script>

</html>